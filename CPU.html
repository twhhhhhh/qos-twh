<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreB - ch2 : CPU 機器周期互動學習平台 / CPU & machine cycle </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto:wght@400;500&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Roboto', sans-serif;
            background-color: #f0f4f8;
            user-select: none;
            padding-bottom: 240px; /* 增加底部內距，適應較長的雙語解釋 */
        }

        .component-slot {
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .component-slot.hovered {
            background-color: #e0e7ff;
            border-color: #4f46e5;
            border-style: solid;
        }

        .component-slot.filled {
            background-color: #dcfce7;
            border-color: #16a34a;
            border-style: solid;
            box-shadow: none;
        }

        .draggable-item {
            cursor: pointer; /* 改為 pointer 提示可點擊 */
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        .draggable-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
        }

        .draggable-item:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .draggable-item.dragging {
            opacity: 0.5;
        }

        .draggable-item.placed {
            cursor: pointer;
            transform: none;
        }

        /* Active/Selected State for Components */
        .draggable-item.selected {
            ring: 4px solid #facc15; /* Yellow ring */
            transform: scale(1.05);
            z-index: 20;
        }

        /* Bus Animation Lines */
        .bus-line {
            stroke-width: 4;
            fill: none;
            stroke-linecap: round;
            transition: color 0.3s;
            stroke: currentColor;
            color: #cbd5e1; /* Default Slate-300 inactive */
        }

        .bus-line.active-address {
            color: #ef4444; /* Red */
            animation: pulse-line 1s infinite;
        }

        .bus-line.active-data {
            color: #3b82f6; /* Blue */
            animation: pulse-line 1s infinite;
        }
        
        .bus-line.active-control {
            color: #eab308; /* Yellow */
            animation: pulse-line 1s infinite;
        }

        @keyframes pulse-line {
            0% { opacity: 0.4; stroke-width: 4; }
            50% { opacity: 1; stroke-width: 6; }
            100% { opacity: 0.4; stroke-width: 4; }
        }

        /* Fixed Footer Styles */
        #status-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 50;
            transform: translateY(100%); /* Initially hidden */
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        #status-box.visible {
            transform: translateY(0);
        }

        .info-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .tag-address { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .tag-data { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .tag-logic { background-color: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6">

    <header class="w-full max-w-6xl px-4 mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">電腦硬件：CPU 機器周期運作</h1>
            <p class="text-slate-600 mt-1">拖放部件以組裝 CPU。點擊任何部件查看詳細解釋。</p>
        </div>
        <button onclick="resetSim()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-medium transition">
            重設頁面
        </button>
    </header>

    <main class="w-full max-w-6xl px-4 flex flex-col lg:flex-row gap-6">
        
        <!-- Left Column: The Motherboard (Drop Zones) -->
        <div class="flex-grow bg-white p-6 rounded-2xl shadow-lg relative border-2 border-slate-200 min-h-[600px]">
            <h2 class="text-xl font-bold text-slate-700 mb-4 absolute top-4 left-6">主機板與 CPU 架構</h2>
            
            <!-- SVG Layer for Buses -->
            <svg class="absolute inset-0 w-full h-full pointer-events-none z-0" id="bus-canvas">
                <defs>
                    <!-- Define arrow marker that inherits color -->
                    <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5"
                        markerWidth="6" markerHeight="6"
                        orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="currentColor" />
                    </marker>
                </defs>

                <!-- PC to MAR -->
                <path id="bus-pc-mar" class="bus-line" d="M200 130 L200 170" marker-end="url(#arrow)" />
                <!-- MAR to RAM (Address Bus) -->
                <path id="bus-mar-ram" class="bus-line" d="M280 210 L580 210" marker-end="url(#arrow)" />
                <!-- RAM to MDR (Data Bus) -->
                <path id="bus-ram-mdr" class="bus-line" d="M580 310 L290 310" marker-end="url(#arrow)" />
                <!-- MDR to CIR -->
                <path id="bus-mdr-cir" class="bus-line" d="M200 340 L200 380" marker-end="url(#arrow)" />
                <!-- CIR to CU -->
                <path id="bus-cir-cu" class="bus-line" d="M250 420 L380 420 L380 470" marker-end="url(#arrow)" />
                <!-- CU to ALU (Control Signal) -->
                <path id="bus-cu-alu" class="bus-line" d="M350 510 L290 510" marker-end="url(#arrow)" />
                <!-- ALU to ACC -->
                <path id="bus-alu-acc" class="bus-line" d="M200 540 L200 570" marker-end="url(#arrow)" />
            </svg>

            <!-- CPU Container Box -->
            <div class="absolute top-16 left-16 w-[350px] h-[550px] border-4 border-slate-300 rounded-xl bg-slate-50/50 z-0">
                <span class="absolute top-2 left-2 text-slate-400 font-bold text-2xl opacity-20">CPU (中央處理器)</span>
            </div>

            <!-- Slots -->
            
            <!-- PC -->
            <div class="absolute top-20 left-[150px] w-32">
                <div id="slot-pc" data-accept="pc" class="component-slot w-full h-16 border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center bg-white/80 relative z-10"></div>
            </div>

            <!-- MAR -->
            <div class="absolute top-[180px] left-[150px] w-32">
                <div id="slot-mar" data-accept="mar" class="component-slot w-full h-16 border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center bg-white/80 relative z-10"></div>
            </div>

            <!-- MDR -->
            <div class="absolute top-[280px] left-[150px] w-32">
                <div id="slot-mdr" data-accept="mdr" class="component-slot w-full h-16 border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center bg-white/80 relative z-10"></div>
            </div>

            <!-- CIR -->
            <div class="absolute top-[390px] left-[150px] w-32">
                <div id="slot-cir" data-accept="cir" class="component-slot w-full h-16 border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center bg-white/80 relative z-10"></div>
            </div>

            <!-- ALU -->
            <div class="absolute top-[480px] left-[150px] w-32">
                <div id="slot-alu" data-accept="alu" class="component-slot w-full h-16 border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center bg-white/80 relative z-10"></div>
            </div>

            <!-- CU -->
            <div class="absolute top-[480px] left-[320px] w-32">
                <div id="slot-cu" data-accept="cu" class="component-slot w-full h-16 border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center bg-white/80 relative z-10"></div>
            </div>

             <!-- ACC -->
             <div class="absolute top-[580px] left-[150px] w-32">
                <div id="slot-acc" data-accept="acc" class="component-slot w-full h-16 border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center bg-white/80 relative z-10"></div>
            </div>

            <!-- RAM Container -->
            <div class="absolute top-[150px] right-[50px] w-48 h-[300px] border-4 border-slate-300 rounded-xl bg-slate-50/50 z-0">
                <span class="absolute top-2 left-2 text-slate-400 font-bold text-2xl opacity-20">Memory</span>
            </div>

            <!-- RAM Slot -->
            <div class="absolute top-[200px] right-[60px] w-40">
                <div id="slot-ram" data-accept="ram" class="component-slot w-full h-48 border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center bg-white/80 relative z-10"></div>
            </div>

            <!-- Bus Labels -->
            <div class="absolute top-[190px] left-[350px] text-xs text-red-500 font-bold bg-white px-1">位址匯流排 (Address)</div>
            <div class="absolute top-[290px] left-[350px] text-xs text-blue-500 font-bold bg-white px-1">數據匯流排 (Data)</div>

        </div>

        <!-- Right Column: Toolbox & Controls -->
        <div class="w-full lg:w-64 flex flex-col gap-4">
            
            <!-- Toolbox -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <h2 class="text-lg font-bold text-slate-700 mb-4 border-b pb-2">部件庫 (Toolbox)</h2>
                <p class="text-xs text-slate-500 mb-4">請拖放部件，或點擊以查看功能解釋。</p>
                
                <div class="grid grid-cols-2 lg:grid-cols-1 gap-3" id="toolbox">
                    <!-- Components -->
                    <div id="item-pc" draggable="true" class="draggable-item bg-indigo-500 text-white p-3 rounded shadow-md text-center text-sm font-bold" data-id="pc">
                        程式計數器<br>(PC)
                    </div>
                    <div id="item-mar" draggable="true" class="draggable-item bg-indigo-500 text-white p-3 rounded shadow-md text-center text-sm font-bold" data-id="mar">
                        記憶體位址寄存器<br>(MAR)
                    </div>
                    <div id="item-mdr" draggable="true" class="draggable-item bg-indigo-500 text-white p-3 rounded shadow-md text-center text-sm font-bold" data-id="mdr">
                        記憶體數據寄存器<br>(MDR)
                    </div>
                    <!-- RAM Visual -->
                    <div id="item-ram" draggable="true" class="draggable-item bg-green-600 text-white p-1 rounded shadow-md text-center text-xs font-bold h-24 flex flex-col items-center justify-center overflow-hidden" data-id="ram">
                        <div class="w-full text-center border-b border-green-500 pb-1 mb-1">主記憶體 (RAM)</div>
                        <table class="w-full text-[10px] bg-green-700 rounded">
                            <tr class="border-b border-green-600"><th>位址</th><th>內容</th></tr>
                            <tr class="bg-green-800"><td>1000</td><td>ADD 1001</td></tr>
                            <tr><td>1001</td><td>0005 (Data)</td></tr>
                        </table>
                    </div>
                    <div id="item-cir" draggable="true" class="draggable-item bg-indigo-500 text-white p-3 rounded shadow-md text-center text-sm font-bold" data-id="cir">
                        現行指令寄存器<br>(CIR)
                    </div>
                    <div id="item-cu" draggable="true" class="draggable-item bg-amber-600 text-white p-3 rounded shadow-md text-center text-sm font-bold" data-id="cu">
                        控制部件<br>(CU)
                    </div>
                    <div id="item-alu" draggable="true" class="draggable-item bg-purple-600 text-white p-3 rounded shadow-md text-center text-sm font-bold" data-id="alu">
                        算術及邏輯<br>運算部件 (ALU)
                    </div>
                    <div id="item-acc" draggable="true" class="draggable-item bg-indigo-500 text-white p-3 rounded shadow-md text-center text-sm font-bold" data-id="acc">
                        累加器<br>(AX)
                    </div>
                </div>
            </div>

            <!-- Control Panel (Initially Hidden/Disabled) -->
            <div id="control-panel" class="bg-slate-800 text-white p-4 rounded-2xl shadow-lg border border-slate-600 opacity-50 pointer-events-none transition-opacity">
                <h3 class="text-sm font-bold text-yellow-400 mb-3 border-b border-slate-600 pb-2">機器周期控制</h3>
                <div class="flex flex-col gap-2">
                    <button id="next-step-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                        <span>▶</span> 下一步 (Next)
                    </button>
                    <button id="reset-cycle-btn" class="bg-slate-600 hover:bg-slate-500 text-gray-200 font-bold py-2 rounded-lg text-sm transition-colors">
                        ↺ 重置周期
                    </button>
                </div>
                <div class="mt-3 text-xs text-center text-gray-400">
                    進度: <span id="step-counter">0</span> / 7
                </div>
            </div>

        </div>

    </main>

    <!-- Fixed Footer Status Box -->
    <div id="status-box" class="bg-slate-900 border-t-4 border-yellow-500 p-6">
        <div class="max-w-6xl mx-auto flex items-start gap-4">
            <div class="bg-yellow-500/20 p-2 rounded-full hidden sm:block shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="flex-grow">
                <h3 class="text-lg font-bold text-yellow-400 mb-1" id="status-title">歡迎 (Welcome)</h3>
                <div id="status-text" class="text-slate-200 text-base leading-relaxed">
                    請將右側部件庫中的部件拖放到主機板上正確的虛線框中以開始。<br>
                    <span class="text-sm text-slate-400 block mt-1">Please drag and drop components from the toolbox on the right to their correct slots on the motherboard to start.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Component Data (Detailed Explanations) ---
        const componentDetails = {
            'pc': {
                title: "程式計數器 (Program Counter - PC)",
                typeTag: "<span class='info-tag tag-address'>儲存內容: 位址 (Address)</span>",
                desc: "<strong>主要作用 (Function):</strong><br>儲存**下一個**將被執行指令的記憶體位址。當指令被提取後，PC 的數值會自動加 1。<br><span class='text-sm text-blue-200 block mt-1'>Stores the memory address of the **next** instruction to be executed. The PC increments by 1 automatically after an instruction is fetched.</span>"
            },
            'mar': {
                title: "記憶體位址寄存器 (Memory Address Register - MAR)",
                typeTag: "<span class='info-tag tag-address'>儲存內容: 位址 (Address)</span>",
                desc: "<strong>主要作用 (Function):</strong><br>暫存即將從主記憶體讀取或寫入數據的**位址**。它是 CPU 與地址匯流排之間的接口。<br><span class='text-sm text-blue-200 block mt-1'>Temporarily holds the **address** of the memory location to be accessed (read from or written to). It acts as the interface between the CPU and the Address Bus.</span>"
            },
            'mdr': {
                title: "記憶體數據寄存器 (Memory Data Register - MDR)",
                typeTag: "<span class='info-tag tag-data'>儲存內容: 數據/指令 (Data/Instruction)</span>",
                desc: "<strong>主要作用 (Function):</strong><br>暫存從記憶體讀取的數據/指令，或準備寫入記憶體的數據。它是 CPU 與數據匯流排之間的接口。<br><span class='text-sm text-blue-200 block mt-1'>Temporarily holds **data or instructions** fetched from memory, or data waiting to be stored in memory. It acts as the interface to the Data Bus.</span>"
            },
            'ram': {
                title: "主記憶體 (Main Memory - RAM)",
                typeTag: "<span class='info-tag tag-data'>儲存內容: 數據與指令 (Data & Instructions)</span>",
                desc: "<strong>主要作用 (Function):</strong><br>儲存當前正在運行的程式指令及相關數據。每個存儲單元都有唯一的位址。<br><span class='text-sm text-blue-200 block mt-1'>Stores program instructions and data that are currently in use. Each storage unit has a unique address.</span>"
            },
            'cir': {
                title: "現行指令寄存器 (Current Instruction Register - CIR)",
                typeTag: "<span class='info-tag tag-data'>儲存內容: 指令 (Instruction)</span>",
                desc: "<strong>主要作用 (Function):</strong><br>儲存**目前正在被解碼和執行**的指令。控制部件 (CU) 會讀取這裡的內容來決定下一步操作。<br><span class='text-sm text-blue-200 block mt-1'>Stores the instruction **currently being decoded and executed**. The Control Unit (CU) reads from here to determine the next operation.</span>"
            },
            'cu': {
                title: "控制部件 (Control Unit - CU)",
                typeTag: "<span class='info-tag tag-logic'>功能單元 (Functional Unit)</span>",
                desc: "<strong>主要作用 (Function):</strong><br>CPU 的「大腦」。負責**譯碼 (Decode)** 指令，並向 ALU、記憶體和其他部件發出控制訊號來協調運作。<br><span class='text-sm text-blue-200 block mt-1'>The 'brain' of the CPU. It **decodes** instructions and sends control signals to the ALU, memory, and other components to coordinate operations.</span>"
            },
            'alu': {
                title: "算術及邏輯運算部件 (Arithmetic Logic Unit - ALU)",
                typeTag: "<span class='info-tag tag-logic'>功能單元 (Functional Unit)</span>",
                desc: "<strong>主要作用 (Function):</strong><br>負責執行所有**算術運算** (如加、減) 和**邏輯運算** (如 AND, OR, 比較大小)。<br><span class='text-sm text-blue-200 block mt-1'>Performs all **arithmetic operations** (e.g., addition, subtraction) and **logical operations** (e.g., AND, OR, comparisons).</span>"
            },
            'acc': {
                title: "累加器 (Accumulator - AX/ACC)",
                typeTag: "<span class='info-tag tag-data'>儲存內容: 數據 (Data)</span>",
                desc: "<strong>主要作用 (Function):</strong><br>一個通用寄存器，用來**暫存 ALU 的運算結果**。在進行連續運算時非常重要。<br><span class='text-sm text-blue-200 block mt-1'>A general-purpose register used to **temporarily store the results** of ALU operations. It is crucial for continuous calculations.</span>"
            }
        };

        // --- Game State ---
        const totalItems = 8;
        let placedItems = 0;
        let currentStepIndex = 0;
        let isSimulating = false;

        // --- Data: Simulation Steps (Bilingual) ---
        const simulationSteps = [
            {
                title: "步驟 1: 提取 (Fetch)",
                text: "程式計數器 (PC) 將下一個指令的記憶體位址 [1000] 傳送至記憶體位址寄存器 (MAR)。<br><span class='text-sm text-blue-200 block mt-1'>The Program Counter (PC) sends the memory address [1000] of the next instruction to the Memory Address Register (MAR).</span>",
                activeBus: "bus-pc-mar",
                busType: "active-address"
            },
            {
                title: "步驟 2: 提取 (Fetch)",
                text: "MAR 透過位址匯流排，向主記憶體 (RAM) 發出讀取位址 [1000] 的請求。<br><span class='text-sm text-blue-200 block mt-1'>The MAR sends a request via the Address Bus to the Main Memory (RAM) to read address [1000].</span>",
                activeBus: "bus-mar-ram",
                busType: "active-address"
            },
            {
                title: "步驟 3: 提取 (Fetch)",
                text: "RAM 響應請求，將位址 [1000] 內的指令數據 [ADD 1001] 透過數據匯流排傳送至 MDR。<br><span class='text-sm text-blue-200 block mt-1'>The RAM responds by sending the instruction data [ADD 1001] from address [1000] to the MDR via the Data Bus.</span>",
                activeBus: "bus-ram-mdr",
                busType: "active-data"
            },
            {
                title: "步驟 4: 提取完成 (Fetch Complete)",
                text: "指令 [ADD 1001] 由 MDR 複製到現行指令寄存器 (CIR)，準備進行譯碼。<br><span class='text-sm text-blue-200 block mt-1'>The instruction [ADD 1001] is copied from the MDR to the Current Instruction Register (CIR) for decoding.</span>",
                activeBus: "bus-mdr-cir",
                busType: "active-data"
            },
            {
                title: "步驟 5: 譯碼 (Decode)",
                text: "控制部件 (CU) 讀取 CIR 中的指令並進行解碼。CU 識別出這是加法指令，需要數據 [1001]。同時 PC 數值加 1。<br><span class='text-sm text-blue-200 block mt-1'>The Control Unit (CU) decodes the instruction in the CIR. It identifies an ADD instruction requiring data from [1001]. Meanwhile, the PC increments by 1.</span>",
                activeBus: "bus-cir-cu",
                busType: "active-control"
            },
            {
                title: "步驟 6: 執行 (Execute)",
                text: "CU 發出控制訊號給 ALU。ALU 從位址 [1001] 讀取數據 [0005] 並執行加法運算。<br><span class='text-sm text-blue-200 block mt-1'>The CU signals the ALU. The ALU reads data [0005] from address [1001] and performs the addition.</span>",
                activeBus: "bus-cu-alu",
                busType: "active-control"
            },
            {
                title: "步驟 7: 儲存 (Store)",
                text: "運算結果被寫入累加器 (AX/ACC)。機器周期結束，準備處理下一個指令。<br><span class='text-sm text-blue-200 block mt-1'>The result is stored in the Accumulator (AX/ACC). The machine cycle ends, ready for the next instruction.</span>",
                activeBus: "bus-alu-acc",
                busType: "active-data"
            }
        ];

        // --- Event Listeners Setup ---
        const draggables = document.querySelectorAll('.draggable-item');
        const slots = document.querySelectorAll('.component-slot');
        const controlPanel = document.getElementById('control-panel');
        const nextStepBtn = document.getElementById('next-step-btn');
        const resetCycleBtn = document.getElementById('reset-cycle-btn');
        const stepCounter = document.getElementById('step-counter');

        // Add Click Listener to all draggables (for info display)
        draggables.forEach(draggable => {
            draggable.addEventListener('click', (e) => {
                // Prevent drag logic interfering with click if needed, though usually distinct
                e.stopPropagation();
                
                // Highlight selection
                draggables.forEach(d => d.classList.remove('selected'));
                draggable.classList.add('selected');

                const id = draggable.getAttribute('data-id');
                showComponentInfo(id);
            });

            // Drag Events
            draggable.addEventListener('dragstart', () => {
                draggable.classList.add('dragging');
                // Select it when dragging starts too
                draggables.forEach(d => d.classList.remove('selected'));
                draggable.classList.add('selected');
                showComponentInfo(draggable.getAttribute('data-id'));
            });
            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
            });
        });

        slots.forEach(slot => {
            slot.addEventListener('dragover', (e) => {
                e.preventDefault();
                if(!slot.hasChildNodes()) {
                    slot.classList.add('hovered');
                }
            });

            slot.addEventListener('dragleave', () => {
                slot.classList.remove('hovered');
            });

            slot.addEventListener('drop', (e) => {
                e.preventDefault();
                slot.classList.remove('hovered');

                const draggable = document.querySelector('.dragging');
                if (!draggable) return;

                const expectedId = slot.getAttribute('data-accept');
                const itemId = draggable.getAttribute('data-id');

                if (expectedId === itemId) {
                    slot.appendChild(draggable);
                    slot.classList.add('filled');
                    draggable.setAttribute('draggable', 'false');
                    draggable.classList.add('placed');
                    draggable.classList.remove('bg-indigo-500', 'bg-green-600', 'bg-amber-600', 'bg-purple-600');
                    draggable.classList.add('bg-slate-700');
                    
                    placedItems++;
                    checkCompletion();
                    // Keep showing info for the dropped item
                    showComponentInfo(itemId); 
                } else {
                    showStatus("位置錯誤 (Incorrect)", "這個部件不屬於這裡，請參考筆記重新嘗試。<br><span class='text-sm text-red-200 block mt-1'>This component does not belong here. Please refer to your notes and try again.</span>", "red");
                }
            });
        });

        function checkCompletion() {
            if (placedItems === totalItems) {
                // Enable Control Panel
                controlPanel.classList.remove('opacity-50', 'pointer-events-none');
                controlPanel.classList.add('opacity-100', 'animate-pulse'); // Pulse once to draw attention
                setTimeout(() => controlPanel.classList.remove('animate-pulse'), 2000);
            }
        }

        // --- Control Logic ---
        
        nextStepBtn.addEventListener('click', () => {
            if (currentStepIndex >= simulationSteps.length) {
                // Cycle finished
                return;
            }

            // Perform Step
            const stepData = simulationSteps[currentStepIndex];
            
            // 1. Clear previous highlights
            document.querySelectorAll('.bus-line').forEach(el => el.classList.remove('active-address', 'active-data', 'active-control'));
            
            // 2. Highlight current bus
            const busEl = document.getElementById(stepData.activeBus);
            if (busEl) busEl.classList.add(stepData.busType);

            // 3. Show Status
            showStatus(stepData.title, stepData.text, "blue");

            // 4. Update index and UI
            currentStepIndex++;
            stepCounter.innerText = currentStepIndex;

            // 5. Check if finished
            if (currentStepIndex >= simulationSteps.length) {
                nextStepBtn.innerHTML = "<span>✓</span> 演示完成 (Done)";
                nextStepBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                nextStepBtn.classList.add('bg-green-600', 'hover:bg-green-500');
                showStatus("演示完成 (Simulation Finished)", "你已完成整個機器周期的觀察。點擊「重置周期」可重新開始。<br><span class='text-sm text-green-200 block mt-1'>You have completed the machine cycle observation. Click 'Reset Cycle' to start over.</span>", "green");
            }
        });

        resetCycleBtn.addEventListener('click', () => {
            // Reset Logic
            currentStepIndex = 0;
            stepCounter.innerText = "0";
            
            // Reset Button Style
            nextStepBtn.innerHTML = "<span>▶</span> 下一步 (Next)";
            nextStepBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            nextStepBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
            
            // Clear Lines
            document.querySelectorAll('.bus-line').forEach(el => el.classList.remove('active-address', 'active-data', 'active-control'));
            
            // Clear selections
            document.querySelectorAll('.draggable-item').forEach(d => d.classList.remove('selected'));

            showStatus("已重置 (Reset)", "請點擊「下一步」重新開始演示。<br><span class='text-sm text-blue-200 block mt-1'>Cycle reset. Please click 'Next Step' to restart the simulation.</span>", "blue");
        });

        // --- Display Helper Functions ---

        const statusBox = document.getElementById('status-box');
        const statusTitle = document.getElementById('status-title');
        const statusText = document.getElementById('status-text');

        // Initial show
        setTimeout(() => {
            statusBox.classList.add('visible');
        }, 500);

        function showComponentInfo(id) {
            const info = componentDetails[id];
            if (info) {
                // Construct HTML with type tag and desc
                const fullHtml = `
                    <div class="mb-2">${info.typeTag}</div>
                    <div>${info.desc}</div>
                `;
                showStatus(info.title, fullHtml, 'yellow');
            }
        }

        function showStatus(title, htmlContent, colorType) {
            statusTitle.innerText = title;
            statusText.innerHTML = htmlContent;
            
            // Update Border Color & Title Color
            statusBox.classList.remove('border-yellow-500', 'border-green-500', 'border-red-500', 'border-blue-500');
            statusTitle.classList.remove('text-yellow-400', 'text-green-400', 'text-red-400', 'text-blue-400');
            
            if (colorType === 'green') {
                statusBox.classList.add('border-green-500');
                statusTitle.classList.add('text-green-400');
            } else if (colorType === 'red') {
                statusBox.classList.add('border-red-500');
                statusTitle.classList.add('text-red-400');
            } else if (colorType === 'blue') {
                statusBox.classList.add('border-blue-500');
                statusTitle.classList.add('text-blue-400');
            } else {
                statusBox.classList.add('border-yellow-500');
                statusTitle.classList.add('text-yellow-400');
            }
        }

        window.resetSim = function() {
            location.reload();
        }

    </script>
</body>
</html>
