<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreB ch3 - é›»è…¦ç³»çµ±æ•¸æ“šè™•ç† (System software) </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif; /* é è¨­ä¸­æ–‡å­—å‹ */
            background-color: #f3f4f6;
            overflow-x: hidden;
        }
        body.lang-en {
            font-family: 'Roboto', sans-serif; /* è‹±æ–‡å­—å‹ */
        }
        canvas {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        
        /* OS é¢æ¿å‹•ç•« */
        .slide-in-right {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <header class="bg-blue-600 text-white p-4 shadow-md z-10">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 id="header-title" class="text-xl md:text-2xl font-bold">CoreB ch3 - é›»è…¦ç³»çµ±æ•¸æ“šè™•ç†</h1>
                <p id="header-subtitle" class="text-sm opacity-90">ç³»çµ±è»Ÿä»¶æ¶æ§‹</p>
            </div>
            
            <div class="flex gap-3">
                <button id="scenario-btn" class="bg-yellow-400 hover:bg-yellow-500 text-blue-900 font-bold py-2 px-4 rounded-full transition duration-300 shadow-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    <span id="scenario-btn-text">æ¨¡æ“¬ä¾‹å­ï¼šæ‰“é–‹å½±ç‰‡</span>
                </button>

                <button id="lang-btn" class="bg-white/20 hover:bg-white/30 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 backdrop-blur-sm border border-white/30">
                    Switch to English
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ï¼šCanvas èˆ‡ å´é‚Šæ¬„ -->
    <main class="flex-grow flex items-center justify-center p-4 bg-gray-100 relative">
        <div class="relative w-full max-w-6xl h-full flex flex-row gap-4 items-center justify-center">
            
            <!-- å·¦å´ï¼šCanvas ç¹ªåœ–å€ -->
            <div class="relative flex-grow h-full flex flex-col items-center justify-center">
                 <!-- æŒ‡å¼•æ–‡å­— -->
                <div id="instruction-overlay" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white/80 backdrop-blur px-4 py-2 rounded-lg text-gray-600 text-sm shadow animate-pulse pointer-events-none z-10">
                    é»æ“Šä¸‹æ–¹æ–¹å¡ŠæŸ¥çœ‹è©³ç´°åŠŸèƒ½
                </div>
                <canvas id="systemCanvas" class="w-full h-[500px] md:h-[600px] border border-gray-200"></canvas>
            </div>

            <!-- å³å´ï¼šOS è©³ç´°åŠŸèƒ½é¢æ¿ (é è¨­éš±è—) -->
            <div id="os-panel" class="hidden w-80 bg-white rounded-xl shadow-xl border-l-4 border-yellow-400 p-5 flex-col gap-4 slide-in-right absolute right-4 top-1/2 transform -translate-y-1/2 md:static md:translate-y-0 md:h-[600px] z-20">
                <div class="flex items-center gap-2 border-b pb-3 mb-2">
                    <span class="text-3xl">âš™ï¸</span>
                    <div>
                        <h2 id="os-panel-title" class="text-lg font-bold text-gray-800">æ“ä½œç³»çµ±åŠŸèƒ½</h2>
                        <p id="os-panel-subtitle" class="text-xs text-gray-500">Operating System Functions</p>
                    </div>
                    <button onclick="closeOSPanel()" class="ml-auto text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <!-- OS åŠŸèƒ½åˆ—è¡¨å®¹å™¨ï¼Œå…§å®¹ç”± JS ç”Ÿæˆ -->
                <div id="os-functions-container" class="space-y-4 overflow-y-auto pr-1 custom-scrollbar flex-1">
                    <!-- Dynamic Content -->
                </div>
            </div>

        </div>
    </main>

    <!-- åº•éƒ¨è³‡è¨Šæ¬„ -->
    <footer class="bg-white border-t border-gray-300 p-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20 transition-all duration-300" id="info-footer">
        <div class="container mx-auto max-w-4xl">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-blue-100 rounded-lg hidden md:block" id="icon-container">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 id="info-title" class="text-xl font-bold text-gray-800 mb-1">æº–å‚™å°±ç·’</h3>
                    <p id="info-desc" class="text-gray-700 text-lg mb-1">è«‹é»æ“Šä¸Šæ–¹çš„æµç¨‹åœ–çµ„ä»¶ï¼Œæˆ–æŒ‰ä¸‹ã€Œæ¨¡æ“¬ä¾‹å­ã€æŒ‰éˆ•é–‹å§‹å­¸ç¿’ã€‚</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // --- 1. èªè¨€é…ç½®èˆ‡å…¨åŸŸè®Šæ•¸ ---
        let currentLang = 'zh'; // 'zh' or 'en'

        const translations = {
            zh: {
                headerTitle: "CoreB ch3 - é›»è…¦ç³»çµ±æ•¸æ“šè™•ç†",
                headerSubtitle: "ç³»çµ±è»Ÿä»¶çš„æ¶æ§‹",
                scenarioBtn: "æ¨¡æ“¬ä¾‹å­ï¼šæ‰“é–‹å½±ç‰‡",
                langBtn: "Switch to English",
                instruction: "é»æ“Šä¸‹æ–¹æ–¹å¡ŠæŸ¥çœ‹è©³ç´°åŠŸèƒ½",
                osPanelTitle: "æ“ä½œç³»çµ±åŠŸèƒ½",
                osPanelSubtitle: "æ ¸å¿ƒç®¡ç†ä»»å‹™",
                readyTitle: "æº–å‚™å°±ç·’",
                readyDesc: "è«‹é»æ“Šä¸Šæ–¹çš„æµç¨‹åœ–çµ„ä»¶ï¼Œæˆ–æŒ‰ä¸‹ã€Œæ¨¡æ“¬ä¾‹å­ã€æŒ‰éˆ•é–‹å§‹å­¸ç¿’ã€‚",
                simCompleteTitle: "æ¨¡æ“¬å®Œæˆ",
                simCompleteDesc: "å½±ç‰‡å·²æˆåŠŸåœ¨è¢å¹•ä¸Šæ’­æ”¾ã€‚"
            },
            en: {
                headerTitle: "CoreB - Ch3 System software operation",
                headerSubtitle: "How operating system works",
                scenarioBtn: "Simulation: Open Video",
                langBtn: "åˆ‡æ›è‡³ä¸­æ–‡",
                instruction: "Click nodes below for details",
                osPanelTitle: "OS Functions",
                osPanelSubtitle: "Core Management Tasks",
                readyTitle: "Ready",
                readyDesc: "Please click on the diagram components above, or press the 'Simulation' button to start.",
                simCompleteTitle: "Simulation Complete",
                simCompleteDesc: "The video is now playing on the screen."
            }
        };

        // --- 2. é…ç½®èˆ‡æ•¸æ“š (çµ„ä»¶èˆ‡OSåŠŸèƒ½) ---
        
        // å®šç¾©ç³»çµ±çµ„ä»¶ (Nodes) - åŒ…å«é›™èªæ¨™ç±¤èˆ‡æè¿°
        const nodes = [
            { 
                id: 'user', 
                labelZh: 'ç”¨æˆ¶', labelEn: 'User',
                x: 0.1, y: 0.5, 
                color: '#60A5FA', // Blue
                icon: 'ğŸ‘¤',
                descZh: 'ç™¼å‡ºæŒ‡ä»¤çš„äººã€‚ä¾‹å¦‚æ±ºå®šè§€çœ‹ä¸€æ®µå½±ç‰‡ï¼Œä¸¦é€éè‚¢é«”å‹•ä½œï¼ˆå¦‚æ‰‹æŒ‡é»æ“Šï¼‰æ“ä½œã€‚',
                descEn: 'The person who initiates commands. E.g., decides to watch a video and operates via physical actions like clicking.'
            },
            { 
                id: 'input', 
                labelZh: 'è¼¸å…¥è£ç½®', labelEn: 'Input Device',
                x: 0.25, y: 0.5, 
                color: '#34D399', // Green
                icon: 'ğŸ–±ï¸',
                descZh: 'å°‡ç‰©ç†å‹•ä½œè½‰ç‚ºé›»å­è¨Šè™Ÿã€‚éƒ¨åˆ†è£ç½®éœ€å®‰è£é©…å‹•ç¨‹å¼ (Driver) è®“ OS è­˜åˆ¥è£ç½®åŠé€²è¡Œæºé€šã€‚',
                descEn: 'Converts physical actions to signals. Some devices require to install a Driver program for the OS to recognize the device.'
            },
            { 
                id: 'app', 
                labelZh: 'æ‡‰ç”¨è»Ÿä»¶', labelEn: 'Application',
                x: 0.4, y: 0.3, 
                color: '#F87171', // Red
                icon: 'â–¶ï¸',
                descZh: 'åŸ·è¡Œç‰¹å®šä»»å‹™çš„è»Ÿä»¶ã€‚ä¾‹å¦‚ï¼šå½±ç‰‡æ’­æ”¾å™¨ (Video Player) è§£è®€å½±ç‰‡æª”æ¡ˆæ ¼å¼ã€‚',
                descEn: 'Software for specific tasks. E.g., Video Player decodes the video file format.'
            },
            { 
                id: 'interface', 
                labelZh: 'ç”¨æˆ¶ç•Œé¢', labelEn: 'Interface (GUI)',
                x: 0.4, y: 0.7, 
                color: '#A78BFA', // Purple
                icon: 'ğŸªŸ',
                descZh: 'äººæ©Ÿæºé€šçš„æ©‹æ¨‘ã€‚åœ–å½¢ç”¨æˆ¶ç•Œé¢ (GUI) é¡¯ç¤ºåœ–æ¨™å’Œè¦–çª—ï¼Œè®“ç”¨æˆ¶çŸ¥é“é»æ“Šå“ªè£¡ã€‚',
                descEn: 'Bridge for HCI. Graphical User Interface (GUI) visualizes icons/windows to guide user interaction.'
            },
            { 
                id: 'os', 
                labelZh: 'ç³»çµ±è»Ÿä»¶(OS)', labelEn: 'OS\nOperating System',
                x: 0.58, y: 0.5, 
                color: '#FBBF24', // Yellow
                icon: 'âš™ï¸',
                descZh: 'æ“ä½œç³»çµ± (å¦‚ Windows)ã€‚ç¸½æŒ‡æ®ï¼Œè² è²¬ç®¡ç† Processã€Memory åŠ User æ¬Šé™ (è¦‹å³å´)ã€‚',
                descEn: 'Operating System. The commander managing Processes, Memory, and Users (See panel on right).'
            },
            { 
                id: 'hardware', 
                labelZh: 'ç¡¬ä»¶', labelEn: 'Hardware',
                x: 0.75, y: 0.5, 
                color: '#9CA3AF', // Gray
                icon: 'ğŸ’»',
                descZh: 'å¯¦éš›åŸ·è¡Œè¨ˆç®—å’Œå­˜å„²æ•¸æ“šçš„ç‰©ç†è¨­å‚™ (CPU/RAM)ã€‚CPU è™•ç†æŒ‡ä»¤ï¼Œç¡¬ç¢Ÿè®€å–å½±ç‰‡æ•¸æ“šã€‚\n å³æ˜¯ Ch2 æ‰€å­¸ç¿’çš„æ©Ÿå™¨å‘¨æœŸ',
                descEn: 'Physical equipment (CPU/RAM). CPU executes instructions; Disk reads video data. *Which is the machine cycle in Ch2'
            },
            { 
                id: 'output', 
                labelZh: 'è¼¸å‡ºè£ç½®', labelEn: 'Output Device',
                x: 0.9, y: 0.5, 
                color: '#34D399', // Green
                icon: 'ğŸ–¥ï¸',
                descZh: 'å°‡çµæœè½‰ç‚ºäººé¡å¯è®€å½¢å¼ã€‚å¯èƒ½è©²è£ç½®çš„é€éé©…å‹•ç¨‹å¼ (Driver) å°‡æ•¸æ“šè½‰è­¯æˆç•«é¢æˆ–è²éŸ³ã€‚',
                descEn: 'Converts results to readable forms. Requires a Driver to translate data into video/audio.'
            }
        ];

        // OS é¢æ¿åŠŸèƒ½åˆ—è¡¨æ•¸æ“š
        const osFunctionsData = [
            {
                colorClass: 'bg-yellow-50 text-yellow-800',
                titleZh: '1. è™•ç†ç¨‹åºç®¡ç† (Process Mgmt)',
                titleEn: '1. Process Management',
                descZh: 'æ±ºå®šå“ªå€‹ç¨‹å¼å¯ä»¥ä½¿ç”¨ CPUã€‚å®‰æ’å¤šå·¥è™•ç† (Multitasking)ï¼Œç¢ºä¿å½±ç‰‡æ’­æ”¾å™¨å’Œç€è¦½å™¨èƒ½åŒæ™‚é‹ä½œã€‚',
                descEn: 'Decides which program gets CPU time. Handles multitasking to ensure video players and browsers run simultaneously.'
            },
            {
                colorClass: 'bg-blue-50 text-blue-800',
                titleZh: '2. è¨˜æ†¶é«”ç®¡ç† (Memory Mgmt)',
                titleEn: '2. Memory Management',
                descZh: 'åˆ†é… RAM çµ¦ä¸åŒçš„æ‡‰ç”¨ç¨‹å¼ã€‚ç¢ºä¿æ‰“é–‹å½±ç‰‡æ™‚æœ‰è¶³å¤ è¨˜æ†¶é«”è¼‰å…¥æ•¸æ“šï¼Œä¸¦åœ¨é—œé–‰å¾Œé‡‹æ”¾ç©ºé–“ã€‚',
                descEn: 'Allocates RAM to applications. Ensures enough memory to load video data and frees space when closed.'
            },
            {
                colorClass: 'bg-green-50 text-green-800',
                titleZh: '3. ç”¨æˆ¶ç®¡ç† (User Mgmt)',
                titleEn: '3. User Management',
                descZh: 'ç®¡ç†å¸³è™Ÿç™»å…¥èˆ‡æ¬Šé™ã€‚ç¢ºä¿åªæœ‰ç²æˆæ¬Šçš„ç”¨æˆ¶æ‰èƒ½å­˜å–ç‰¹å®šæª”æ¡ˆæˆ–å®‰è£è»Ÿä»¶ã€‚',
                descEn: 'Manages logins and permissions. Ensures only authorized users can access files or install software.'
            },
            {
                colorClass: 'bg-purple-50 text-purple-800',
                titleZh: '4. æª”æ¡ˆç®¡ç† (File Mgmt)',
                titleEn: '4. File Management',
                descZh: 'ä»¥éšå±¤å¼ç›®éŒ„ (Folders) çµ„ç¹”æ•¸æ“šï¼Œæ§åˆ¶æª”æ¡ˆçš„è®€å–ã€å¯«å…¥èˆ‡åˆªé™¤ã€‚',
                descEn: 'Organizes data in hierarchical folders. Controls reading, writing, and deleting of files.'
            }
        ];

        // æ¨¡æ“¬å ´æ™¯çš„è·¯å¾‘èˆ‡é›™èªæ–‡å­—
        const scenarioPath = [
            { node: 'user', textZh: '1. ç”¨æˆ¶æ±ºå®šçœ‹å½±ç‰‡', textEn: '1. User decides to watch video' },
            { node: 'input', textZh: '2. æ»‘é¼ é»æ“Šå½±ç‰‡åœ–æ¨™', textEn: '2. Mouse clicks video icon' },
            { node: 'os', textZh: '3. OS é€é Driver æ¥æ”¶è¨Šè™Ÿ', textEn: '3. OS receives signal via Driver' },
            { node: 'interface', textZh: '4. ç•Œé¢ç¢ºèªé»æ“Šäº†åœ–æ¨™', textEn: '4. Interface confirms click' },
            { node: 'app', textZh: '5. å½±ç‰‡æ’­æ”¾å™¨å•Ÿå‹•', textEn: '5. Video Player launches' },
            { node: 'os', textZh: '6. OS åˆ†é…è¨˜æ†¶é«”ä¸¦è®€å–æª”æ¡ˆ', textEn: '6. OS allocates memory & reads file' },
            { node: 'hardware', textZh: '7. CPU/ç¡¬ç¢Ÿè®€å–æ•¸æ“š', textEn: '7. CPU/Disk process data' },
            { node: 'os', textZh: '8. æ•¸æ“šå‚³å›ç³»çµ±', textEn: '8. Data returned to system' },
            { node: 'output', textZh: '9. é€é Driver é¡¯ç¤ºç•«é¢', textEn: '9. Display video via Driver' }
        ];

        const connections = [
            { from: 'user', to: 'input' },
            { from: 'input', to: 'os' }, 
            { from: 'os', to: 'interface' },
            { from: 'interface', to: 'app' },
            { from: 'app', to: 'os' }, 
            { from: 'os', to: 'hardware' },
            { from: 'hardware', to: 'os' },
            { from: 'os', to: 'output' }
        ];

        // --- 3. èªè¨€åˆ‡æ›é‚è¼¯ ---

        function updatePageLanguage() {
            const t = translations[currentLang];
            
            // æ›´æ–°éœæ…‹æ–‡å­—
            document.getElementById('header-title').textContent = t.headerTitle;
            document.getElementById('header-subtitle').textContent = t.headerSubtitle;
            document.getElementById('scenario-btn-text').textContent = t.scenarioBtn;
            document.getElementById('lang-btn').textContent = t.langBtn;
            document.getElementById('instruction-overlay').textContent = t.instruction;
            document.getElementById('os-panel-title').textContent = t.osPanelTitle;
            document.getElementById('os-panel-subtitle').textContent = t.osPanelSubtitle;
            
            // æ›´æ–° Footer (å¦‚æœä¸æ˜¯åœ¨æ¨¡æ“¬ä¸­)
            if (simulationStep === -1 && activeNodeId === null) {
                document.getElementById('info-title').textContent = t.readyTitle;
                document.getElementById('info-desc').textContent = t.readyDesc;
            } else if (simulationStep === -1 && activeNodeId !== null) {
                // å¦‚æœæœ‰é»é¸ç¯€é»ï¼Œé‡æ–°æ•´ç†è©²ç¯€é»è³‡è¨Š
                const node = nodes.find(n => n.id === activeNodeId);
                updateFooter(node);
            }

            // æ›´æ–° OS é¢æ¿å…§å®¹
            renderOSPanel();

            // é‡ç¹ª Canvas (æ›´æ–°ç¯€é»æ–‡å­—)
            draw();

            // åˆ‡æ› Body class ä»¥æ”¹è®Šå­—å‹
            if (currentLang === 'en') {
                document.body.classList.add('lang-en');
            } else {
                document.body.classList.remove('lang-en');
            }
        }

        function renderOSPanel() {
            const container = document.getElementById('os-functions-container');
            container.innerHTML = ''; // æ¸…ç©º

            osFunctionsData.forEach(item => {
                const div = document.createElement('div');
                div.className = `${item.colorClass.split(' ')[0]} p-3 rounded-lg`; // åªå– bg color class

                const title = document.createElement('h3');
                title.className = `font-bold ${item.colorClass.split(' ')[1]} text-sm mb-1`;
                title.textContent = currentLang === 'zh' ? item.titleZh : item.titleEn;

                const p = document.createElement('p');
                p.className = 'text-xs text-gray-700 leading-relaxed';
                p.textContent = currentLang === 'zh' ? item.descZh : item.descEn;

                div.appendChild(title);
                div.appendChild(p);
                container.appendChild(div);
            });
        }

        document.getElementById('lang-btn').addEventListener('click', () => {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updatePageLanguage();
        });

        // --- 4. Canvas åˆå§‹åŒ–èˆ‡ç¹ªåœ– ---

        const canvas = document.getElementById('systemCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let animationFrameId;
        let particles = [];
        let activeNodeId = null;
        let simulationStep = -1;

        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            width = canvas.width;
            height = canvas.height;
            draw();
        }

        window.addEventListener('resize', resizeCanvas);

        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
            return ctx;
        }

        function drawArrow(ctx, fromX, fromY, toX, toY) {
            const headlen = 10;
            const dx = toX - fromX;
            const dy = toY - fromY;
            const angle = Math.atan2(dy, dx);
            const offset = 40; 
            const endX = toX - offset * Math.cos(angle);
            const endY = toY - offset * Math.sin(angle);
            const startX = fromX + offset * Math.cos(angle);
            const startY = fromY + offset * Math.sin(angle);

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - headlen * Math.cos(angle - Math.PI / 6), endY - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(endX - headlen * Math.cos(angle + Math.PI / 6), endY - headlen * Math.sin(angle + Math.PI / 6));
            ctx.fill();
        }

        function getNodeRect(node) {
            const boxW = 110;
            const boxH = 90;
            const cx = node.x * width;
            const cy = node.y * height;
            return {
                x: cx - boxW / 2,
                y: cy - boxH / 2,
                w: boxW,
                h: boxH,
                cx: cx,
                cy: cy
            };
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);

            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#cbd5e1';

            connections.forEach(conn => {
                const n1 = nodes.find(n => n.id === conn.from);
                const n2 = nodes.find(n => n.id === conn.to);
                const r1 = getNodeRect(n1);
                const r2 = getNodeRect(n2);
                drawArrow(ctx, r1.cx, r1.cy, r2.cx, r2.cy);
            });

            nodes.forEach(node => {
                const rect = getNodeRect(node);
                
                ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                ctx.shadowBlur = 10;
                
                if (activeNodeId === node.id) {
                    ctx.shadowColor = node.color;
                    ctx.shadowBlur = 20;
                    ctx.strokeStyle = node.color;
                    ctx.lineWidth = 4;
                } else {
                    ctx.strokeStyle = 'transparent';
                }

                ctx.fillStyle = '#ffffff';
                roundRect(ctx, rect.x, rect.y, rect.w, rect.h, 10).fill();
                if (activeNodeId === node.id) ctx.stroke();
                
                ctx.fillStyle = node.color;
                ctx.shadowBlur = 0;
                ctx.beginPath();
                ctx.roundRect(rect.x, rect.y, rect.w, 10, [10, 10, 0, 0]);
                ctx.fill();

                ctx.fillStyle = '#1f2937';
                ctx.font = currentLang === 'zh' ? 'bold 16px "Noto Sans TC"' : 'bold 14px "Roboto"';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // æ ¹æ“šèªè¨€ç²å–æ¨™ç±¤
                const label = currentLang === 'zh' ? node.labelZh : node.labelEn;
                // è™•ç†å¯èƒ½çš„å¤šè¡Œæ–‡å­— (è‹¥æœ‰)
                const lines = label.split('\n');
                
                if (lines.length > 1) {
                    ctx.fillText(lines[0], rect.cx, rect.cy + 5);
                    ctx.font = '11px sans-serif';
                    ctx.fillText(lines[1], rect.cx, rect.cy + 22);
                } else {
                    ctx.fillText(label, rect.cx, rect.cy + 15);
                }

                ctx.font = '24px serif';
                ctx.fillText(node.icon, rect.cx, rect.cy - 15);
            });

            particles.forEach((p, index) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                ctx.fillStyle = '#F59E0B'; 
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                const dx = p.targetX - p.x;
                const dy = p.targetY - p.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < 5) {
                    particles.splice(index, 1);
                } else {
                    p.x += (dx / dist) * 4; 
                    p.y += (dy / dist) * 4;
                }
            });

            animationFrameId = requestAnimationFrame(draw);
        }

        // --- 5. äº’å‹•é‚è¼¯ ---

        function updateFooter(node) {
            const titleEl = document.getElementById('info-title');
            const descEl = document.getElementById('info-desc');
            const container = document.getElementById('info-footer');

            container.classList.add('bg-blue-50');
            setTimeout(() => container.classList.remove('bg-blue-50'), 300);

            // æ ¹æ“šèªè¨€æ›´æ–°
            const label = currentLang === 'zh' ? node.labelZh : node.labelEn;
            const desc = currentLang === 'zh' ? node.descZh : node.descEn;

            titleEl.textContent = `${node.icon} ${label}`;
            descEl.textContent = desc;
            titleEl.style.color = node.color;
        }

        // è™•ç† OS é¢æ¿é–‹é—œ
        const osPanel = document.getElementById('os-panel');
        
        function closeOSPanel() {
            osPanel.classList.add('hidden');
            osPanel.classList.remove('flex');
            // å¦‚æœç•¶å‰æ˜¯ OS è¢«é¸ä¸­ï¼Œæ¸…é™¤é¸ä¸­ç‹€æ…‹
            if (activeNodeId === 'os' && simulationStep === -1) {
                activeNodeId = null;
            }
        }

        function toggleOSPanel(show) {
            if (show) {
                osPanel.classList.remove('hidden');
                osPanel.classList.add('flex');
            } else {
                osPanel.classList.add('hidden');
                osPanel.classList.remove('flex');
            }
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            let clickedNode = null;

            nodes.forEach(node => {
                const r = getNodeRect(node);
                if (mouseX >= r.x && mouseX <= r.x + r.w &&
                    mouseY >= r.y && mouseY <= r.y + r.h) {
                    clickedNode = node;
                }
            });

            if (clickedNode) {
                activeNodeId = clickedNode.id;
                updateFooter(clickedNode);
                toggleOSPanel(clickedNode.id === 'os');
                
                if (simulationStep === -1) {
                    const neighborConn = connections.find(c => c.from === clickedNode.id);
                    if (neighborConn) {
                        const target = nodes.find(n => n.id === neighborConn.to);
                        const startR = getNodeRect(clickedNode);
                        const endR = getNodeRect(target);
                        particles.push({
                            x: startR.cx, y: startR.cy,
                            targetX: endR.cx, targetY: endR.cy
                        });
                    }
                }
            } else {
                activeNodeId = null;
                // è‹¥é»æ“Šç©ºç™½è™•ï¼Œå¾©åŸé è¨­æ–‡å­—
                const t = translations[currentLang];
                document.getElementById('info-title').textContent = t.readyTitle;
                document.getElementById('info-desc').textContent = t.readyDesc;
                document.getElementById('info-title').style.color = '#1f2937'; // gray-800
                toggleOSPanel(false);
            }
        });

        // --- 6. æ¨¡æ“¬å ´æ™¯é‚è¼¯ ---

        function runScenario() {
            if (simulationStep !== -1) return;

            simulationStep = 0;
            const stepDelay = 1500;
            const t = translations[currentLang];
            
            toggleOSPanel(false);

            function nextStep() {
                if (simulationStep >= scenarioPath.length) {
                    simulationStep = -1;
                    activeNodeId = null;
                    document.getElementById('info-title').textContent = t.simCompleteTitle;
                    document.getElementById('info-desc').textContent = t.simCompleteDesc;
                    document.getElementById('info-title').style.color = '#10B981'; // green
                    return;
                }

                const currentStep = scenarioPath[simulationStep];
                const node = nodes.find(n => n.id === currentStep.node);
                
                activeNodeId = node.id;
                
                // æ ¹æ“šèªè¨€æ›´æ–°æ­¥é©Ÿæ–‡å­—
                const stepText = currentLang === 'zh' ? currentStep.textZh : currentStep.textEn;
                const stepPrefix = currentLang === 'zh' ? "æ­¥é©Ÿ" : "Step";
                
                document.getElementById('info-title').textContent = `${stepPrefix} ${simulationStep + 1}`;
                document.getElementById('info-desc').textContent = stepText;
                document.getElementById('info-title').style.color = node.color;

                if (simulationStep < scenarioPath.length - 1) {
                    const nextNodeId = scenarioPath[simulationStep + 1].node;
                    const nextNode = nodes.find(n => n.id === nextNodeId);
                    
                    const startR = getNodeRect(node);
                    const endR = getNodeRect(nextNode);
                    
                    for(let i=0; i<3; i++) {
                        setTimeout(() => {
                            particles.push({
                                x: startR.cx, y: startR.cy,
                                targetX: endR.cx, targetY: endR.cy
                            });
                        }, i * 200);
                    }
                }

                simulationStep++;
                setTimeout(nextStep, stepDelay);
            }

            nextStep();
        }

        document.getElementById('scenario-btn').addEventListener('click', runScenario);

        // åˆå§‹åŒ–
        updatePageLanguage(); // åŸ·è¡Œä¸€æ¬¡åˆå§‹åŒ–èªè¨€
        setTimeout(resizeCanvas, 100); 
        draw();

    </script>
</body>
</html>